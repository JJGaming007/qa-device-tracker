<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QA Device Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>

<div class="toast-container position-fixed top-0 end-0 p-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
            <div class="toast align-items-center text-white bg-{{ 'danger' if category == 'danger' else 'success' }} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">{{ message }}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        {% endfor %}
    {% endwith %}
</div>

<div style="position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 16px;">
    <label class="switch">
        <input type="checkbox" id="themeToggle">
        <span class="slider"></span>
    </label>

    {% if current_user.is_authenticated and current_user.role == 'admin' %}
        <a href="{{ url_for('manage_users') }}" class="button">Manage Users</a>
    {% endif %}

    <form action="{{ url_for('logout') }}" method="get" style="margin: 0;">
        <button type="submit" class="button logout">Logout</button>
    </form>
</div>

<div class="header" style="flex-direction: column; align-items: center; justify-content: center; margin-top: 20px;">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo" style="margin-bottom: 8px;">
    <h1 class="page-title">QA Device Tracker</h1>
</div>

<form method="get" class="dropdown-form">
    <input type="text" id="searchBox" name="search" placeholder="Search by device name or serial number" value="{{ request.args.get('search', '') }}">
    <button type="submit" class="button">Search</button>
</form>

{% if devices %}
    <table>
    <thead>
        <tr>
            <th>#</th>
            <th>Device Name</th>
            <th>Serial Number</th>
            <th>Status</th>
            <th>Owner</th>
            <th>Updated On</th>
            <th>Assign</th>
            <th>Return</th>
        </tr>
    </thead>
    <tbody>
{% for device in devices %}
<tr>
    <td>{{ device.sr_no }}</td>
    <td>{{ device.device_name }}</td>
    <td>{{ device.serial_number }}</td>
    <td>{{ device.status }}</td>
    <td>
        {% if device.assigned_to %}
            {{ device.assigned_to }}
        {% else %}
            Not assigned
        {% endif %}
    </td>
    <td>{{ device.updated_on.strftime('%Y-%m-%d %H:%M') if device.updated_on else 'N/A' }}</td>
    <td>
        {% if not device.assigned_to %}
        <form action="{{ url_for('assign_device') }}" method="post">
            <input type="hidden" name="sr_no" value="{{ device.sr_no }}">
            <input type="text" name="assigned_to" value="{{ device.assigned_to or '' }}">
            <button type="submit">Assign</button>
        </form>
        {% else %}
            —
        {% endif %}
    </td>
    <td>
        {% if device.assigned_to %}
        <form action="{{ url_for('return_device') }}" method="post">
            <input type="hidden" name="sr_no" value="{{ device.sr_no }}">
            <button type="submit">Return</button>
        </form>
        {% else %}
            —
        {% endif %}
    </td>
</tr>
{% endfor %}
</tbody>
</table>
{% else %}
    <p>No device data found.</p>
{% endif %}

<!-- Theme toggle script -->
<script>
    const toggle = document.getElementById('themeToggle');
    const body = document.body;

    toggle.addEventListener('change', () => {
        body.classList.toggle('dark');
        localStorage.setItem('theme', body.classList.contains('dark') ? 'dark' : 'light');
    });

    window.onload = () => {
        const theme = localStorage.getItem('theme');
        if (theme === 'dark') {
            body.classList.add('dark');
            toggle.checked = true;
        }
    };
</script>

<!-- Search field auto-reset -->
<script>
    const searchBox = document.getElementById('searchBox');
    const searchForm = searchBox.closest('form');
    searchBox.addEventListener('input', function () {
        if (this.value.trim() === '') {
            const url = new URL(window.location);
            url.searchParams.delete('search');
            window.location.href = url.toString();
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const toasts = document.querySelectorAll('.toast');
        toasts.forEach(function (el) {
            const toast = new bootstrap.Toast(el, { delay: 5000 });
            toast.show();
        });
    });
</script>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();

  socket.on('device_updated', (data) => {
    console.log('Device updated:', data);
    location.reload();
  });
</script>

</body>
</html>
