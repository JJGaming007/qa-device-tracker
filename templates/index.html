<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QA Device Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
    body {
        font-family: 'Inter', sans-serif;
        padding: 20px;
        background-color: #f9f9f9;
    }
    .header {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        margin-bottom: 20px;
    }
    .logo {
        height: 60px;
        margin-bottom: 8px;
    }
    .page-title {
        font-size: 2rem;
        font-weight: 600;
    }
    .device-count {
        margin: 20px 0;
        font-weight: 500;
    }
    .search-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
    }
    .search-container input {
        min-width: 300px;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .search-container button,
    .button {
        padding: 8px 15px;
        background-color: #4a6cf7;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: 500;
    }
    .button.logout {
        background-color: #dc3545;
    }
    .button:hover {
        opacity: 0.9;
    }
    .top-right {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    table {
        width: 100%;
    }
    @media (max-width: 768px) {
        table {
            display: block;
            overflow-x: auto;
        }
    }

    /* Checkbox styling */
    .device-checkbox {
        transform: scale(1.2);
        margin-right: 8px;
    }
    
    .select-all-container {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .tally-info {
        margin-left: 20px;
        font-weight: 500;
        color: #4a6cf7;
    }

    /* ✅ Enhanced Dark Mode Styling */
    body.dark {
        background-color: #121212;
        color: #f1f1f1;
    }
    body.dark .container,
    body.dark .header,
    body.dark .device-count {
        background-color: #121212;
        color: #f1f1f1;
    }
    
    /* Fixed table dark mode styling */
    body.dark .table {
        background-color: #1e1e1e !important;
        color: #ffffff !important;
        border-color: #444 !important;
    }
    body.dark .table th,
    body.dark .table td {
        background-color: #1e1e1e !important;
        color: #ffffff !important;
        border-color: #444 !important;
    }
    body.dark .table thead th {
        background-color: #2c2c2c !important;
        color: #ffffff !important;
        border-color: #555 !important;
    }
    body.dark .table-light {
        background-color: #2c2c2c !important;
        color: #ffffff !important;
    }
    body.dark .table-hover tbody tr:hover {
        background-color: #2a2a2a !important;
        color: #ffffff !important;
    }
    body.dark .table-hover tbody tr:hover td {
        background-color: #2a2a2a !important;
        color: #ffffff !important;
    }
    
    body.dark .search-container input {
        background-color: #2e2e2e;
        color: #ffffff;
        border: 1px solid #555;
    }
    body.dark input::placeholder {
        color: #bbbbbb;
    }
    body.dark .search-container button,
    body.dark .button {
        background-color: #4a6cf7;
        color: #fff;
    }
    body.dark .button.logout {
        background-color: #dc3545;
    }
    body.dark .btn-primary {
        background-color: #4a6cf7;
        border-color: #4a6cf7;
    }
    body.dark .btn-warning {
        background-color: #f0ad4e;
        border-color: #f0ad4e;
    }
    body.dark .toast.bg-success {
        background-color: #28a745 !important;
    }
    body.dark .toast.bg-danger {
        background-color: #dc3545 !important;
    }
    body.dark .tally-info {
        color: #6c8fff;
    }
    
    /* Theme toggle switch styling */
    .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }
    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    input:checked + .slider {
        background-color: #4a6cf7;
    }
    input:checked + .slider:before {
        transform: translateX(26px);
    }
</style>

</head>
<body>

<div class="top-right">
    <label class="switch">
        <input type="checkbox" id="themeToggle">
        <span class="slider"></span>
    </label>

    {% if current_user.is_authenticated and current_user.role == 'admin' %}
        <a href="{{ url_for('manage_users') }}" class="button">Manage Users</a>
    {% endif %}

    <form action="{{ url_for('logout') }}" method="get" style="margin: 0;">
        <button type="submit" class="button logout">Logout</button>
    </form>
</div>

<div class="header">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="logo">
    <h1 class="page-title">QA Device Tracker</h1>
</div>

<div class="toast-container position-fixed top-0 end-0 p-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, message in messages %}
            <div class="toast align-items-center text-white bg-{{ 'danger' if category == 'danger' else 'success' }} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">{{ message }}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        {% endfor %}
    {% endwith %}
</div>

<div class="search-container">
    <form method="get" class="dropdown-form">
        <input type="text" id="searchBox" name="search" placeholder="Search by device name, serial number, status, or owner" value="{{ request.args.get('search', '') }}">
        <button type="submit" class="button">Search</button>
    </form>
</div>

<div class="container">
    <div class="device-count">
        Total devices: {{ devices|length }}
        {% if request.args.get('search') %}(filtered){% endif %}
    </div>

    {% if devices %}
        <div class="select-all-container">
            <input type="checkbox" id="selectAll" class="device-checkbox">
            <label for="selectAll">Select All</label>
            <span class="tally-info" id="tallyInfo">Selected: 0</span>
        </div>
        
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Select</th>
                    <th>#</th>
                    <th>Device Name</th>
                    <th>Serial Number</th>
                    <th>Status</th>
                    <th>Owner</th>
                    <th>Updated On</th>
                    <th>Assign</th>
                    <th>Return</th>
                </tr>
            </thead>
            <tbody>
                {% for device in devices %}
                <tr>
                    <td>
                        <input type="checkbox" class="device-checkbox device-select" data-sr-no="{{ device.sr_no }}">
                    </td>
                    <td>{{ device.sr_no }}</td>
                    <td>{{ device.device_name }}</td>
                    <td>{{ device.serial_number }}</td>
                    <td>{{ device.status }}</td>
                    <td>{{ device.assigned_to or 'Not assigned' }}</td>
                    <td>{{ device.updated_on.strftime('%Y-%m-%d %H:%M') if device.updated_on else 'N/A' }}</td>
                    <td>
                        {% if not device.assigned_to %}
                        <form action="{{ url_for('assign_device') }}" method="post" class="d-flex flex-column gap-1">
                            <input type="hidden" name="sr_no" value="{{ device.sr_no }}">
                            <input type="text" name="assigned_to" placeholder="Name">
                            <button type="submit" class="btn btn-sm btn-primary">Assign</button>
                        </form>
                        {% else %}—{% endif %}
                    </td>
                    <td>
                        {% if device.assigned_to %}
                        <form action="{{ url_for('return_device') }}" method="post">
                            <input type="hidden" name="sr_no" value="{{ device.sr_no }}">
                            <button type="submit" class="btn btn-sm btn-warning">Return</button>
                        </form>
                        {% else %}—{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No device data found.</p>
    {% endif %}
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<script>
    // Theme toggle
    const toggle = document.getElementById('themeToggle');
    const body = document.body;

    toggle.addEventListener('change', () => {
        body.classList.toggle('dark');
        localStorage.setItem('theme', body.classList.contains('dark') ? 'dark' : 'light');
    });

    window.onload = () => {
        const theme = localStorage.getItem('theme');
        if (theme === 'dark') {
            body.classList.add('dark');
            toggle.checked = true;
        }
    };

    // Auto-hide toast
    document.addEventListener("DOMContentLoaded", function () {
        const toasts = document.querySelectorAll('.toast');
        toasts.forEach(el => new bootstrap.Toast(el, { delay: 5000 }).show());
    });

    // Auto-clear search
    document.getElementById('searchBox').addEventListener('input', function () {
        if (this.value.trim() === '') {
            const url = new URL(window.location);
            url.searchParams.delete('search');
            window.location.href = url.toString();
        }
    });

    // Live reload on device update
    const socket = io();
    socket.on('device_updated', (data) => {
        console.log('Device updated:', data);
        location.reload();
    });

    // Checkbox functionality for tallying
    document.addEventListener('DOMContentLoaded', function() {
        const selectAllCheckbox = document.getElementById('selectAll');
        const deviceCheckboxes = document.querySelectorAll('.device-select');
        const tallyInfo = document.getElementById('tallyInfo');

        // Update tally count
        function updateTally() {
            const checkedCount = document.querySelectorAll('.device-select:checked').length;
            tallyInfo.textContent = `Selected: ${checkedCount}`;
        }

        // Select all functionality
        selectAllCheckbox.addEventListener('change', function() {
            deviceCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateTally();
        });

        // Individual checkbox change
        deviceCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                // Update select all checkbox state
                const checkedCount = document.querySelectorAll('.device-select:checked').length;
                selectAllCheckbox.checked = checkedCount === deviceCheckboxes.length;
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < deviceCheckboxes.length;
                
                updateTally();
            });
        });

        // Initialize tally
        updateTally();
    });
</script>
</body>
</html>